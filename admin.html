<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Certificate Verification</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.8);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --success: #10b981;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.1);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Login State */
        #login-view {
            height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Dashboard View */
        #dashboard-view {
            display: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .stat-val {
            font-size: 2rem;
            font-weight: 800;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab {
            cursor: pointer;
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .tab.active {
            color: white;
            background: var(--bg-secondary);
        }

        .panel {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 24px;
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        td {
            padding: 12px;
            border-top: 1px solid var(--border);
            font-size: 0.95rem;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.valid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge.revoked {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Bulk Import */
        .drop-zone {
            border: 2px dashed var(--border);
            padding: 40px;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 20px;
        }

        .drop-zone:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        #import-preview {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Login View -->
        <div id="login-view">
            <div class="login-card">
                <h2 style="margin-bottom: 30px;">Admin Access</h2>
                <div class="input-group">
                    <label>Admin Secret Key</label>
                    <input type="password" id="admin-secret" placeholder="Enter secret key...">
                </div>
                <button class="btn" onclick="login()">Access Dashboard</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view">
            <header class="header">
                <div>
                    <h1>Admin Panel</h1>
                    <p style="color: var(--text-secondary);">Manage certificates and view analytics</p>
                </div>
                <button class="btn" style="width: auto; background: var(--bg-secondary);"
                    onclick="logout()">Logout</button>
            </header>

            <div class="stats-grid">
                <div class="stat-card">
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Certificates</div>
                    <div class="stat-val" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Active</div>
                    <div class="stat-val" id="stat-active" style="color: var(--success);">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Revoked</div>
                    <div class="stat-val" id="stat-revoked" style="color: var(--error);">0</div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('list')">Manage Certificates</div>
                <div class="tab" onclick="switchTab('import')">Bulk Import</div>
            </div>

            <!-- List Panel -->
            <div id="list-panel" class="panel active">
                <h3>Issued Certificates</h3>
                <div id="cert-list-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Code</th>
                                <th>Event</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cert-list-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Import Panel -->
            <div id="import-panel" class="panel">
                <h3>Bulk Certificate Import</h3>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Upload a CSV file with headers:
                    <code>code, name, event, issuer, issued_on</code></p>

                <div class="drop-zone" onclick="document.getElementById('csv-input').click()">
                    <p>Click to upload CSV or drag & drop</p>
                    <input type="file" id="csv-input" hidden accept=".csv" onchange="handleFile(this)">
                </div>

                <div id="import-preview" style="display: none;">
                    <h4>Preview (<span id="preview-count">0</span> items)</h4>
                    <table id="preview-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Event</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button class="btn" style="margin-top: 20px;" onclick="uploadImport()">Start Import</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://cert-verify-api.coding-council-jmi.workers.dev';
        let adminSecret = localStorage.getItem('admin_secret');
        let importData = [];

        async function api(path, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'x-admin-secret': adminSecret
            };

            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            const res = await fetch(`${API_BASE}${path}`, options);
            if (res.status === 401) {
                logout();
                throw new Error('Unauthorized');
            }
            return res.json();
        }

        function login() {
            const input = document.getElementById('admin-secret').value;
            if (!input) return;
            adminSecret = input;
            loadDashboard().then(() => {
                localStorage.setItem('admin_secret', adminSecret);
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('dashboard-view').style.display = 'block';
            }).catch(e => {
                alert('Invalid Secret Key');
            });
        }

        function logout() {
            localStorage.removeItem('admin_secret');
            window.location.reload();
        }

        async function loadDashboard() {
            const data = await api('/api/admin/analytics');
            document.getElementById('stat-total').textContent = data.stats.total;
            document.getElementById('stat-active').textContent = data.stats.active;
            document.getElementById('stat-revoked').textContent = data.stats.revoked || 0;

            await loadCertList();
        }

        async function loadCertList() {
            const data = await api('/api/admin/list');
            const tbody = document.getElementById('cert-list-body');
            tbody.innerHTML = '';

            data.results.forEach(cert => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cert.name}</td>
                    <td style="font-family: monospace;">${cert.code}</td>
                    <td>${cert.event}</td>
                    <td>
                        <span class="badge ${cert.revoked ? 'revoked' : 'valid'}">
                            ${cert.revoked ? 'Revoked' : 'Active'}
                        </span>
                    </td>
                    <td>
                        <button class="btn" style="width: auto; padding: 4px 10px; font-size: 0.8rem; background: ${cert.revoked ? 'var(--success)' : 'var(--error)'};" 
                                onclick="toggleRevoke('${cert.code}', ${cert.revoked ? 0 : 1})">
                            ${cert.revoked ? 'Un-revoke' : 'Revoke'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function toggleRevoke(code, revoked) {
            if (!confirm(`Are you sure you want to ${revoked ? 'revoke' : 'restore'} this certificate?`)) return;
            await api('/api/admin/revoke', 'POST', { code, revoked });
            loadDashboard();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            if (tab === 'list') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('list-panel').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('import-panel').classList.add('active');
            }
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const rows = text.split('\n').filter(row => row.trim());
                const headers = rows[0].split(',').map(h => h.trim().toLowerCase());

                importData = rows.slice(1).map(row => {
                    const vals = row.split(',').map(v => v.trim());
                    const obj = {};
                    headers.forEach((h, i) => obj[h] = vals[i]);
                    return obj;
                });

                showPreview();
            };
            reader.readAsText(file);
        }

        function showPreview() {
            const container = document.getElementById('import-preview');
            const tbody = document.querySelector('#preview-table tbody');
            document.getElementById('preview-count').textContent = importData.length;

            tbody.innerHTML = '';
            importData.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.code}</td><td>${row.name}</td><td>${row.event}</td>`;
                tbody.appendChild(tr);
            });

            container.style.display = 'block';
        }

        async function uploadImport() {
            if (!confirm(`Import ${importData.length} certificates?`)) return;

            try {
                document.getElementById('import-panel').classList.add('loading');
                await api('/api/admin/bulk-import', 'POST', { certificates: importData });
                alert('Import successful!');
                importData = [];
                document.getElementById('import-preview').style.display = 'none';
                switchTab('list');
                loadDashboard();
            } catch (e) {
                alert('Import failed: ' + e.message);
            } finally {
                document.getElementById('import-panel').classList.remove('loading');
            }
        }

        // Init
        if (adminSecret) {
            login();
        }
    </script>
</body>

</html>